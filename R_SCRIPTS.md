### R Scripts (Orchestration and Post-processing)

-   **`00_RUN_Province_Damage_Update.R`**
    -   **Purpose:** The top-level orchestrator of the entire pipeline. It sets the working directory, defines output paths, manages backups of previous runs, and sequentially calls all other R scripts. It also includes commands for generating raster overviews on the final layers and uploading them to the maps portal.
    -   **Inputs:**
        -   Previous run files (from `/mnt/CEPH_PROJECTS/WALDSCHAEDEN/working_folder/outputs/fordead_15`). Used for backing these up.
        -   Hardcoded paths to previous yearly/monthly shapefiles for area comparison.
    -   **Outputs:**
        -   Backed-up previous run files.
        -   Final yearly and monthly damage GeoTIFFs and Shapefiles (output of the full pipeline).
        -   Refined rasters (application of `gdaladdo`)
        -   Copy of the new maps to the server (`scp` commands).
    -   **Key Actions:**
        -   Sets `setwd()`.
        -   Defines `update_name` and `outfold` (where the final products are saved).
        -   Moves files from `fordead_15` to a backup directory.
        -   Sources `01_Import_S2_data.R`, `03_Mosaic_FORDEAD_Outputs.R`, `04_Refine_And_Mask_Damage_Products.R`, `05_Style_And_Project_Damage_Maps.R`, `06_Integrate_And_Refine_Damage_Products.R`.
        -   Executes `gdaladdo` commands.
        -   Provides `scp` commands for file transfer (to execute manually in a terminal).
        -   Optionally allows a simple area comparisons.
-   **`01_Import_S2_data.R`**
    -   **Purpose:** Manages the acquisition and organization of Sentinel-2 BOA imagery for processing. It defines spatial grids and temporal parameters, and iterates through them, calling `02_Execute_Core_FORDEAD_Processing.R` for each grid and detection period.
    -   **Inputs:**
        -   Configuration parameters (`get_new_images`, `sentinel_only`).
        -   Spatial grid definitions (`grids`).
        -   Temporal parameters (`train_period_max`, `detection_start_dates`, `detection_end_dates`, `ignored_doy`).
    -   **Outputs:**
        -   Organized BOA imagery in `_boa` and `_update` directories for each grid.
    -   **Key Actions:**
        -   Defines global parameters for the FORDEAD process.
        -   Loops through defined `detection_start_dates` and `detection_end_dates`.
        -   For each grid, manages BOA image files, moving "future" images to an `_update` directory and restoring "past" images to the main `_boa` directory.
        -   Sources `02_Execute_Core_FORDEAD_Processing.R` within its main loop.
-   **`02_Execute_Core_FORDEAD_Processing.R`**
    -   **Purpose:** This script is the bridge between the R orchestration and the Python FORDEAD core. It handles initial data preprocessing, QAI mask generation (in R), and prepares and executes the Python FORDEAD scripts for each grid cell and vegetation index.
    -   **Inputs:**
        -   Parameters from `01_Import_S2_data.R` (e.g., `grids`, `train_period_min`, `train_period_max`, `ignored_doy`).
        -   Raw Sentinel-2 BOA and QAI TIFFs from `in_path`.
        -   Forest mask shapefile (`forest_mask`).
    -   **Outputs:**
        -   Organized BOA data and generated QAI masks in `_boa` directories.
        -   Parameter files (`param.py`) for Python scripts.
        -   Intermediate mask files (`mask_nodata.tif`, `valid_obs.tif`).
        -   Outputs from Python FORDEAD scripts (e.g., `coeff_model.tif`, `sufficient_coverage_mask.tif`).
    -   **Key Actions:**
        -   Defines numerous settings for the FORDEAD process (paths, thresholds, indices).
        -   Manages the `qai_version` and generates/activates QAI masks based on Sentinel-2 QAI data.
        -   Prepares a `param.py` file with various parameters for the Python scripts.
        -   Calls external Python wrapper scripts (`fordead_1.py`, `fordead_2.py`, `fordead_3.py`) using `system()` calls.
        -   Performs a "dummy mask" computation to ensure algorithm stability.
-   **`03_Mosaic_FORDEAD_Outputs.R`**
    -   **Purpose:** Mosaics the tiled outputs (both raster and vector) generated by the FORDEAD process for each vegetation index into full-area maps.
    -   **Inputs:**
        -   Tiled FORDEAD outputs (e.g., `confidence_index.tif`, `dieback.shp`, `stress_periods.shp`, `mask_nodata.tif`, `valid_obs.tif`, `first_date_dieback.tif`, etc.) from `for_out_path`.
        -   `index.list` (implicitly from `02_Execute_Core_FORDEAD_Processing.R`).
    -   **Outputs:**
        -   Merged GeoTIFFs and Shapefiles for various outputs (e.g., `output_NDWI_merged.shp`, `output_confidence_NDVI_merged.tif`).
    -   **Key Actions:**
        -   Loops through each vegetation index in `index.list`.
        -   Identifies and merges corresponding tiled vector files using `terra::vect` and `rbind`.
        -   Identifies and merges corresponding tiled raster files using `terra::vrt` and `writeRaster`.
-   **`04_Refine_And_Mask_Damage_Products.R`**
    -   **Purpose:** Refines the merged outputs by applying additional masking, adjusting temporal periods, and deriving annual products. It also performs area calculations and comparisons.
    -   **Inputs:**
        -   Merged NDVI and NDWI shapefiles (e.g., `output_NDWI_merged.shp`, `output_NDVI_merged.shp`) from `fold` (which is `for_out_path`).
        -   Province boundaries shapefile (`province.shp`).
        -   LAFIS (agricultural measures) shapefile (`lafis.shp`).
        -   A base Sentinel-2 mosaic GeoTIFF (`base`) for rasterization.
        -   A reference bark beetle damage shapefile (`bark_beetle_damages_province.shp`) for comparison.
    -   **Outputs:**
        -   Masked and refined NDVI shapefiles and GeoTIFFs (e.g., `NDVI_merged_masked_with_NDWI.shp`, `NDVI_merged_masked_with_NDWI_province_lafis.shp`, `NDVI_merged_masked_with_NDWI_province_lafis.tif`).
        -   Annual damage GeoTIFF (`NDVI_merged_masked_with_NDWI_province_only_annual.tif`) and shapefile (`bark_beetle_damages_province_annual.shp`).
    -   **Key Actions:**
        -   Loads NDWI and NDVI vector data and rasterizes them.
        -   Masks the NDVI raster with the NDWI raster.
        -   Applies masking using province and LAFIS data.
        -   Adjusts date labels for November and winter periods.
        -   Derives annual damage products.
        -   Calculates and compares damage areas with a reference dataset.
-   **`05_Style_And_Project_Damage_Maps.R`**
    -   **Purpose:** Prepares the yearly and monthly damage products for final output and visualization by applying color palettes, projecting data, and converting formats.
    -   **Inputs:**
        -   Yearly and monthly damage rasters (e.g., `NDVI_merged_masked_with_NDWI_province_only_annual.tif`, `NDVI_merged_masked_with_NDWI_province_lafis.tif`) from `prod_fol` (which is `for_out_path`).
        -   `update_name` (from `00_RUN_Province_Damage_Update.R`).
    -   **Outputs:**
        -   Final yearly and monthly damage GeoTIFFs and Shapefiles (e.g., `changes_yearly_damages_july_2025_25832.tif`, `changes_monthly_damages_july_2025_25832.shp`).
    -   **Key Actions:**
        -   Loads yearly and monthly damage rasters.
        -   Defines and applies color palettes and labels.
        -   Projects rasters to EPSG:25832.
        -   Converts rasters to vector format.
        -   Writes final GeoTIFF and Shapefile outputs.
        -   Includes post-processing adjustments for specific date labels (November, winter periods) and recalculates `last_detectable_date`.
-   **`06_Integrate_And_Refine_Damage_Products.R`**
    -   **Purpose:** Performs the final post-processing steps, integrating previous results, applying additional filters (stress periods, shadows, single pixels), and generating the definitive output products.
    -   **Inputs:**
        -   Current yearly and monthly damage rasters (from `05_Style_And_Project_Damage_Maps.R`).
        -   Previous monthly and yearly damage rasters (hardcoded paths).
        -   NDVI and NDWI stress period rasters (e.g., `output_nb_periods_stress_NDVI_merged.tif`).
        -   QAI data for shadow masking (hardcoded path).
        -   Forest inspectorates shapefile (`ForestInspectorates_polygon.shp`).
        -   A base raster for projection (`base`).
    -   **Outputs:**
        -   Final yearly and monthly damage GeoTIFFs and Shapefiles (e.g., `changes_monthly_damages_july_2025_25832_final.tif`).
        -   Intermediate post-processing files moved to `post_proc_intermediates` subdirectory.
    -   **Key Actions:**
        -   Loads current and previous damage rasters.
        -   Integrates old detections into current results.
        -   Applies stress period filtering based on combined NDVI/NDWI stress.
        -   Applies shadow masking using QAI data and a specific geographic area (Vipiteno).
        -   Removes single-pixel detections based on area.
        -   Applies all final masks and filters.
        -   Sets color tables and levels for final outputs.
        -   Writes final GeoTIFF and Shapefile outputs with user confirmation.
        -   Moves intermediate files to a dedicated subdirectory.
